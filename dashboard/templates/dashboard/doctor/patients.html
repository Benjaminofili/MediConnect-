{% extends 'dashboard/base_doctor.html' %}
{% load static %}

{% block title %}Patients Grid{% endblock %}

<!-- {% block extra_css %}
<link rel="stylesheet" href="{% static 'dashboard/assets/plugins/select2/css/select2.min.css' %}">
<link rel="stylesheet" href="{% static 'dashboard/assets/css/bootstrap-datetimepicker.min.css' %}">
{% endblock %} -->

{% block content %}
<div class="content">

    <!-- HEADER & FILTERS (Part 1) -->
    <div class="d-flex align-items-sm-center flex-sm-row flex-column gap-2 mb-4">
        <div class="flex-grow-1">
            <h4 class="fw-bold mb-0">
                Patient Grid 
                <span class="badge badge-soft-primary fw-medium border py-1 px-2 border-primary fs-13 ms-1">
                    Total Patients : {{ patients.count }}
                </span>
            </h4>
        </div>
        <div class="text-end d-flex">
            <button type="button" class="btn btn-primary fs-13 btn-md" data-bs-toggle="modal" data-bs-target="#searchPatientModal"><i class="ti ti-search me-1"></i>Search Patient</button>
        </div>
    </div>

    <!-- PATIENT CARDS LOOP (Part 2) -->
    <div class="row">
        {% for patient in patients %}
        {% with profile=patient.patient_profile %}
        <div class="col-xl-4 col-md-6">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div class="d-flex align-items-center">
                            <a href="{% url 'dashboard:doctor_patient_detail' patient.id %}" class="avatar avatar-lg me-2">
                                <img src="{% if patient.profile_picture %}{{ patient.profile_picture.url }}{% else %}{% static 'dashboard/assets/img/users/user-08.jpg' %}{% endif %}" alt="patient" class="rounded-circle">
                            </a>
                            <div class="d-block">
                                <a href="{% url 'dashboard:doctor_patient_detail' patient.id %}" class="text-dark fw-semibold d-block">{{ patient.full_name }}</a>
                                <span class="text-body fs-13 fw-normal"> 
                                    {% if profile.get_age %}{{ profile.get_age }}, {% endif %}
                                    {{ patient.gender|title }} 
                                </span>
                            </div>
                        </div>
                        <div class="dropdown">
                        <a href="javascript:void(0);" class="shadow-sm fs-14 d-inline-flex border rounded-2 p-1" data-bs-toggle="dropdown">
                            <i class="ti ti-dots-vertical"></i>
                        </a>
                        <ul class="dropdown-menu p-2">
                            <li>
                                <a href="{% url 'dashboard:doctor_patient_detail' patient.id %}" class="dropdown-item d-flex align-items-center">
                                    <i class="ti ti-eye me-2 text-primary"></i> View Profile
                                </a>
                            </li>
                            <li>
                                <a href="{% url 'dashboard:doctor_prescription_create' patient.id %}" class="dropdown-item d-flex align-items-center">
                                    <i class="ti ti-prescription me-2 text-success"></i> Write Prescription
                                </a>
                            </li>
                            <li>
                                <a href="javascript:void(0);" class="dropdown-item d-flex align-items-center appointment-btn"
                                data-patient-id="{{ patient.id }}" data-patient-name="{{ patient.full_name }}">
                                    <i class="ti ti-calendar-plus me-2 text-info"></i> New Appointment
                                </a>
                            </li>
                        </ul>
                    </div>
                    </div>
                    
                    {% with last_appt=patient.patient_appointments.first %}
                    <p class="mb-2 text-truncate fs-13 d-flex align-items-center">
                        <i class="ti ti-calendar me-1 text-dark"></i>
                        Last Appointment : 
                        {% if last_appt %}
                            {{ last_appt.date|date:"D, d M Y" }}
                        {% else %}
                            No appointments yet
                        {% endif %}
                    </p>
                    {% endwith %}

                    <p class="mb-0 text-truncate fs-13 d-flex align-items-center">
                        <i class="ti ti-location-pin me-1 text-dark"></i>
                        <span class="text-muted">New York, USA</span>
                    </p>
                </div>
            </div>
        </div>
        {% endwith %}
        {% empty %}
        <div class="col-12">
            <div class="text-center py-5">
                <p class="text-muted">No patients found.</p>
            </div>
        </div>
        {% endfor %}
    </div>

    
</div> <!-- End .content -->

<!-- Search Patient Modal -->
<div class="modal fade" id="searchPatientModal" tabindex="-1" aria-labelledby="searchPatientModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title fw-bold" id="searchPatientModalLabel">Search Patient</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="get" action="{% url 'dashboard:doctor_patients' %}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="search-patient-name" class="form-label">Patient Name or Email</label>
                        <input type="text" class="form-control" id="search-patient-name" name="q" placeholder="Enter patient name or email..." value="{{ request.GET.q }}">
                    </div>
                    <div class="mb-3">
                        <label for="search-patient-gender" class="form-label">Gender</label>
                        <select class="form-select" id="search-patient-gender" name="gender">
                            <option value="">All Genders</option>
                            <option value="male" {% if request.GET.gender == 'male' %}selected{% endif %}>Male</option>
                            <option value="female" {% if request.GET.gender == 'female' %}selected{% endif %}>Female</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Search</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock content %}




<!-- JAVASCRIPT (Part 4 - YOUR CODE) -->
{% block extra_js %}
<!-- <script src="{% static 'dashboard/assets/plugins/select2/js/select2.min.js' %}"></script> -->
<!-- <script src="{% static 'dashboard/assets/js/moment.min.js' %}"></script>
<script src="{% static 'dashboard/assets/js/bootstrap-datetimepicker.min.js' %}"></script> -->

<script>
    $(document).ready(function() {
        // Initialize Select2
        if($('.select').length > 0) {
            $('.select').select2({
                minimumResultsForSearch: -1, // Hides search bar
                width: '100%',
                dropdownParent: $('#filter-dropdown') 
            });
        }
        
        // Initialize Datepicker
        if($('.datetimepicker').length > 0) {
            $('.datetimepicker').datetimepicker({
                format: 'DD/MM/YYYY',
                icons: {
                    up: "fas fa-angle-up",
                    down: "fas fa-angle-down",
                    next: 'fas fa-angle-right',
                    previous: 'fas fa-angle-left'
                }
            });
        }
        
        // Prevent dropdown from closing when clicking inside
        $('.filter-dropdown').on('click', function(e) {
            e.stopPropagation();
        });
        
        // Manual close button for filter
        $('#close-filter').on('click', function(e) {
            e.preventDefault();
            $('.dropdown-toggle').dropdown('hide');
        });

        // Delete Button Logic
        $('.delete-patient-btn').on('click', function(e) {
            e.preventDefault();
            var deleteUrl = $(this).data('url'); 
            $('#confirm-delete-btn').attr('href', deleteUrl); 
            $('#delete_modal').modal('show'); 
        });
    });
</script>
{% endblock %}